---
title: API接口签名验证与参数加密
categories:
  - 更多
tags:
  - 参数加密
  - 签名
date: 2022-03-10
description: 常见的接口参数加密方法，让接口不再裸奔。
---

刚开始写代码时，接口都是裸奔的，客户端抓个包，就能知道所有的请求参数和返回参数，对于一些重要的接口，这样是不安全的。

后来公司开始对所有业务接口进行参数加密处理，就学习了接口的签名和加密的相关规则，做个记录。

## 1 问题引出

调用API接口时，请求方和接口提供方之间的通信过程，需要考虑几个问题：

- 请求参数是否被篡改；
- 请求来源是否合法；
- 请求是否具有唯一性；  



**举个例子：**

客户端 app 调用产品信息查询 api 进行产品查询：

> 请求: http://api.test.com/getproducts?key1=value1&key2=value2

没有进行任何的验证，接口处于裸奔状态，所有人都可以通过这个接口获取到产品列表，导致产品信息泄露。

## 2 参数签名

首先进行一个小优化：**调用API 时需对请求参数进行签名验证** ，规则如下：

- 将所有入参（sign 除外）按照 "key=value" 的格式拼接起来，并且将拼接以后的字符串以 "&" 字符连接。顺序按首字母升序排列，值为空的不参与签名。将拼接好的字符串做 MD5 签名。

> 即：MD5(key1=value1&key2=value2)

- 将生成的签名 sign 添加在请求参数中

> 新的接口：http://api.test.com/getproducts?key1=value1&key2=value2&sign=...

- 后端对请求的 sign 进行校验，需要携带正确的sign才能获取产品数据。



但是，只对请求参数进行做 MD5 签名得到的 sign 还是不安全的，别人同样可以做相同的加密操作进行请求 。

## 3 AccessKey & SecretKey

进一步优化方法：

为开发者分配 **AccessKey**（开发者标识，确保唯一）和 **SecretKey**（用于接口加密)

1. 请求参数中也携带 AccessKey；

2. app 和后端约定一个 SecretKey，用于生成签名；

3. **在上述请求参数字符串中尾部加上 SecretKey 组成一个新字符串，再进行 MD5 加密得到签名 sign**。

   当然也可以使用其他的加密算法

> 即：MD5(key1=value1&key2=value2secret)

请求携带参数**AccessKey**和**Sign**，只有拥有合法的身份 AccessKey 和正确的签名 sign 才能放行。这样就解决了身份验证和参数篡改问题。

如果参数被篡改，没事，因为别人无法知道 SecretKey，也就无法重新生成新的 sign。

注：SecretKey 仅作加密使用, 不参与网络传输，为了保证数据安全请不要在请求参数中使用。

## 4 请求唯一性保证

但是...这样就够了吗？

MD5 签名方法可以保证来源及请求参数的合法性，但是请求链接可能会被抓包而造成泄露，人家拿着这个请求链接反复请求，就可以正常获取数据了，即 **重放攻击**，因此仅仅是如上的优化是不够的！

再次优化：

- 在如上的请求参数中带上 **时间戳** ，并且把时间戳也作为签名的一部分。在接口提供方对时间戳进行验证，只允许一定时间范围内的请求，假设为 5 分钟。后端先校验时间戳，相差超过 5 分钟的请求直接拒绝。

> 新的接口：http://api.test.com/getproducts?key1=value1&key2=value2&timestamp=...&sign=...



以上可以使用自定义注解 + 拦截器进行实现。

## 5 参数加密

### 对称加密

`Symmetric Cryptography`，是最快速、最简单的一种加密方式，加密（encryption）与解密（decryption）使用同样的密钥（secret key）。

常见的对称加密算法如 AES，Advanced Encryption Standard。

对称加密的缺点是密钥的管理与分配，即如何发送秘钥。因为在发送密钥的过程中，密钥有很大的风险被拦截。**通常的做法是将对称加密的密钥进行非对称加密，然后传送给需要它的一方。**

###  非对称加密

`Asymmetric Cryptography`，使用了一对密钥，**公钥（public key） ** 和 **私钥（private key）**。私钥只能由一方安全保管，不能外泄，而公钥则可以发给任何请求它的人。非对称加密使用这对密钥中的一个进行加密，而解密则需要另一个密钥。私钥是不会通过网络发送出去，因此安全性大大提高。

目前最常用的非对称加密算法是 RSA 算法

### 加密方案

目前采用的加密流程为：

1. 为不同的客户端 app 分配了不同的 RSA 加密的公钥，私钥保存在服务器中；
2. 客户端 app 随机生成 AES 密钥并通过 RSA 加密放在请求 header 中；
3. 服务端使用 RSA  的私钥，解密出 AES 密钥原文，从而解密出请求参数；进行业务处理；
4. 使用客户端发过来的 AES 密钥将返回数据加密返回

以上流程可以在过滤器中实现。

## 6 总结

接口签名校验和参数加密是非常常见的接口保护手段。

1. 签名校验使用了 AccessKey & SecretKey + timestamp 的方式，对请求参数进行 MD5 加密得到签名 sign；
2. 参数加密同时使用了 AES 和 RSA 两种加密算法，对称加密的密钥进行非对称加密后传输。

